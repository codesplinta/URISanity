{"version":3,"file":"urisanity.js","sources":["../src/index.js"],"sourcesContent":["/** !\n * @author: https://twitter.com/isocroft\n * @owner: https://twitter.com/codesplinta\n *\n * @Copyright (c) 2021 - 2024\n *\n * @sourced: [first-party] https://github.com/braintree/sanitize-url\n *\n * Based on the well known URI schemes;\n * See: https://en.wikipedia.org/wiki/List_of_URI_schemes\n *\n * @created: 23/06/2021\n * @last-updated: 04/03/2024\n */\n\n/* eslint-disable no-useless-escape */\n\n/* @HINT: all URI schemes that are mostly unsafe for web browsers to launch */\nconst unsafeURISchemeRegex =\n  /^([^\\w]*)(unsafe|javascript|vbscript|app|admin|icloud-sharing|icloud-vetting|help|aim|facetime-audio|applefeedback|ibooks|macappstore|udoc|ts|st|jar|x-apple-helpbasic|(?:x\\-)?radar)/im\n/* @HINT: all URI schemes that are mostly safe for web browsers to launch */\nconst safeInternetURISchemeRegex =\n  /^(?:(?:f|ht)tps?|cid|xmpp|mms|webcal|aaa|acap|bolo|data|blob|file|local|wss?|irc|udp)/im\n/* @CHECK: https://gist.github.com/gruber/249502/61cbb59f099fdf90316c4e409c7523b6d5124f80 */\nconst safeURIRegex =\n  /\\b((?:[a-z][\\w-]+:(?:\\/{1,3}|[a-z0-9%])|www\\d{0,3}[.]|[a-z0-9.\\-]+[.][a-z]{2,4}\\/?)(?:[^\\s()<>]+|\\(([^\\s()<>]+|(\\([^\\s()<>]+\\)))*\\)){0,}(?:\\(([^\\s()<>]+|(\\([^\\s()<>]+\\)))*\\)|[^\\s\\!()\\[\\]{};:\\'\\\"\\.\\,<>?«»“”‘’]){0,})/i\n/* @HINT: */\nconst commsAppURISchemeRegex =\n  /^(whatsapp|zoommtg|slack|mailto|tel|callto|sms|skype)/im\nconst databaseConnectionStringURISchemeRegex =\n  /^(jdbc(:sqlserver|:mysql|:mariadb|:sqlite)?|odbc|postgres(ql)?|mongodb)/im\nconst browserURISchemeRegex = /^(view-source|moz-extension|resource|res|symres|(?:filesystem:|blob:)?chrome-extension|safari|chrome|mxaddon-pkg|mx|mxwebcore|mxjscall|mbinit|safari-resource|opera|webviewprogressproxy|chromenull|chromeinvoke|chromeinvokeimmediate)/im\n/* @CHECK: - FILE URI */\n/* @CHECK: https://www.w3.org/TR/FileAPI/#blob-url - BLOB URL */\nconst fileSystemURISchemeRegex = /^((?:jar:)?file|local|blob)/im\nconst serviceAPIURISchemeRegex = /^(cloudinary|obsidian|gs|s3|grpc|pptr|tmtbff)/im\n\n/* @HINT: */\nconst blockedHosts = [\n  'widgets.amung.us',\n  'v.zilionfast.in',\n  'js.blinkadr.com',\n  'www.superfish.com',\n  'nzj.divdriver.net',\n  'istatic.datafastguru.info',\n  'widgets.amung.us',\n  'xls.searchfun.in',\n  'static.image2play.com'\n]\n\n/* @HINT: All control characters */\nconst ctrlCharactersRegex =\n  /[\\u0000-\\u001F\\u007F-\\u009F\\u2000-\\u200D\\uFEFF]/gim; /* eslint-disable-line */\n// const urlSchemeRegex = /^([^:]+):/gm\n/* @CHECK: https://datatracker.ietf.org/doc/html/rfc2397 - DATA URI */\nconst dataURIBINRegex =\n  /^data:(?:image\\/(?:bmp|gif|jpeg|jpg|png|tiff|webp|svg\\+xml)|video\\/(?:mpeg|mp4|ogg|webm)|audio\\/(?:mp3|oga|ogg|opus));base64,(?:[a-zA-Z0-9\\/+\\n=]+)$/i\nconst dataURITEXTRegex = /^data:(?:text\\/(?:javascript|html|css|plain))(?:;charset=(UTF-8|iso-8859-7))?,(?:.*)$/im\nconst scriptURIRegex = /^(?:vb|java)(?:\\s*)?script/im\nconst webTransportURIRegex = /^(?:(blob:)?https?|wss?|about)/im\nconst relativeFirstCharacters = ['.', '/']\n\n/* @HINT: Global Stub for the Browser, ReactNative, NativeScript, NodeJS */\nconst $globals = typeof self === 'undefined' ? global || {} : self\n/* @HINT: Conditionally access the NodeJS process global */\nconst nodeJSProcess = $globals.process || { versions: { node: '.' }, env: {} }\nconst NODE_MAJOR_VERSION = parseInt(nodeJSProcess.versions.node.split('.')[0])\n\n/* @CHECK: https://developer.mozilla.org/en-US/docs/Web/API/URL#browser_compatibility */\nif (NODE_MAJOR_VERSION <= 12) {\n  if (!$globals.URL) {\n    $globals.URL = function (urlString) {\n      const urlParser = require('url')\n      /* urlParser.parse(): deprecarted in NodeJS v11.x */\n      const parsedUrl =\n        NODE_MAJOR_VERSION <= 11\n          ? urlParser.parse(urlString) /* eslint-disable-line */\n          : urlParser.URL(urlString)\n      return Object.assign({}, parsedUrl, { hostname: parsedUrl.host })\n    }\n  }\n}\n\nfunction isStandardBrowserEnv () {\n  const environ = $globals.navigator\n  return (\n    typeof environ !== 'undefined' &&\n    environ.product.match(/^(ReactNative|NativeScript|NS)$/i) === null\n  )\n}\n\nconst origin = isStandardBrowserEnv()\n  ? $globals.location.origin\n  : ($globals.constants || nodeJSProcess.env).ORIGIN\n\nfunction isRelativeUrlWithoutProtocol (url) {\n  if (typeof url === 'string') {\n    return relativeFirstCharacters.indexOf(url.charAt(0)) > -1\n  }\n  return false\n}\n\n/* @CHECK: https://gist.github.com/blafrance/4053759 */\nfunction extractParamValueFromUri (uri, paramName) {\n  if (!uri || dataURITEXTRegex.test(uri.trim()) || dataURIBINRegex.test(uri.trim())) {\n    return null\n  }\n\n  const regex = new RegExp('[\\\\?&#]' + paramName + '=([^&#]*)')\n  const params = regex.exec(uri.trim())\n  if (params != null) {\n    return unescape(params[1])\n  }\n}\n\nfunction formDataToJSON (elem) {\n  let current, item, key, output, value\n  output = {}\n\n  const entries =\n    elem instanceof $globals.FormData\n      ? elem.entries()\n      : new $globals.FormData(elem).entries()\n\n  try {\n    // Iterate over values, and assign to item.\n    while ((item = entries.next().value) !== null) {\n      // assign to variables to make the code more readable.\n      key = item[0]\n      value = item[1]\n      // Check if key already exist\n      if (Object.prototype.hasOwnProperty.call(output, key)) {\n        current = output[key]\n        if (!Array.isArray(current)) {\n          // If it's not an array, convert it to an array.\n          current = output[key] = [current]\n        }\n        current.push(value) // Add the new value to the array.\n      } else {\n        output[key] = value\n      }\n    }\n  } catch (_) {\n    output = Object.fromEntries(entries)\n  }\n\n  return JSON.stringify(output)\n}\n\nfunction isSameOrigin (uri) {\n  if (!uri || dataURITEXTRegex.test(uri.trim()) || dataURIBINRegex.test(uri.trim())) {\n    return false\n  }\n\n  try {\n    const parsedUrl = new $globals.URL(uri.trim())\n    return origin === parsedUrl.origin\n  } catch (error) {\n    if (error) {\n      return false\n    }\n  }\n}\n\nfunction checkParamsOverWhiteList (uri, paramsWhiteList = [], data = '') {\n  if (!uri || dataURITEXTRegex.test(uri.trim()) || dataURIBINRegex.test(uri.trim())) {\n    return false\n  }\n\n  if (typeof paramsWhiteList !== 'object') {\n    return false\n  }\n\n  const parsedUrl = new $globals.URL(uri.trim())\n  const paramKeys = []\n  const paramValues = []\n\n  let preparedData = null\n\n  try {\n    let json = ''\n    if ('FormData' in $globals && data instanceof $globals.FormData) {\n      if (typeof Object.fromEntries === 'function') {\n        json = formDataToJSON(data)\n      } else {\n        const object = {}\n\n        data.forEach(function (value, key) {\n          object[key] = value\n        })\n\n        json = JSON.stringify(object)\n      }\n    } else {\n      json = data\n    }\n\n    if (typeof json === 'string') {\n      preparedData = JSON.parse(json)\n    }\n  } catch (_) {\n    preparedData = data\n  }\n\n  if (preparedData === '') {\n    parsedUrl.searchParams.forEach(function (...args) {\n      const [value, key] = args\n\n      paramValues.push(unescape(value))\n      paramKeys.push(key)\n    })\n  } else {\n    if (preparedData instanceof Object) {\n      paramValues.concat(Object.values(preparedData))\n      paramKeys.concat(Object.keys(preparedData))\n    }\n  }\n\n  if (paramKeys.length === paramValues.length) {\n    if (paramsWhiteList instanceof Array) {\n      /* @HINT: Check that only the request params we need are attached */\n      /* @HINT: Any other extra params should not be allowed */\n      if (paramKeys.length === paramsWhiteList.length &&\n        paramKeys.slice(0).sort().join('|') === paramsWhiteList.slice(0).sort().join('|')) {\n        return true\n      }\n    } else if (paramsWhiteList instanceof Object) {\n      let paramsCounter = 0\n      for (; paramsCounter < paramKeys.length; paramsCounter++) {\n        const paramKey = paramKeys[paramsCounter]\n        const paramValue = paramValues[paramsCounter]\n        const paramRegex = paramsWhiteList[paramKey]\n\n        if (paramRegex instanceof RegExp) {\n          if (!paramRegex.test(paramValue)) {\n            break\n          }\n        } else {\n          throw new Error(`\"${paramKey}\" does not have a matching regex pattern to match \"${paramValue}\"`)\n        }\n      }\n      if (paramsCounter === paramValues.length) {\n        return true\n      }\n    }\n  }\n\n  return false\n}\n\nfunction sanitizeUrl (url, options = {}) {\n  if (\n    !url ||\n    url.match(/:\\/\\/(?:[#$@=*.!]|[/]){0,}$/) !== null ||\n    url.includes('////////////')\n  ) {\n    return 'about:blank'\n  }\n\n  let sanitizedUrl = url.replace(ctrlCharactersRegex, '').trim()\n\n  if (isRelativeUrlWithoutProtocol(sanitizedUrl)) {\n    const originalSanitized = sanitizedUrl.startsWith('/')\n      ? origin + sanitizedUrl\n      : origin + '/' + sanitizedUrl\n    sanitizedUrl = safeURIRegex.test(originalSanitized)\n      ? originalSanitized\n      : '//'\n  }\n\n  let urlSchemeParseResults =\n    sanitizedUrl.match(safeInternetURISchemeRegex) ||\n    sanitizedUrl.match(commsAppURISchemeRegex) ||\n    sanitizedUrl.match(databaseConnectionStringURISchemeRegex) ||\n    sanitizedUrl.match(browserURISchemeRegex) ||\n    sanitizedUrl.match(serviceAPIURISchemeRegex) ||\n    sanitizedUrl.match(webTransportURIRegex)\n\n  urlSchemeParseResults =\n    urlSchemeParseResults !== null ? urlSchemeParseResults : []\n  const urlScheme = urlSchemeParseResults[0] || ''\n\n  try {\n    const { hostname, pathname, search, hash } = new $globals.URL(\n      sanitizedUrl.toLowerCase()\n    )\n\n    /* @CHECK: https://en.wikipedia.org/wiki/Hostname#Restrictions_on_valid_host_names */\n    /* CHECK: https://datatracker.ietf.org/doc/html/rfc3986 */\n    if (\n      /^(?:((?:www|[a-z]{1,11})\\.)(?!\\1)(?:[a-z\\-\\d]{1,63})\\.(?:[a-z.\\-\\d]{2,63}))$/i.test(\n        hostname\n      ) ||\n      /^(((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))$/.test(\n        hostname\n      ) ||\n      /^\\s*((([0-9A-Fa-f]{1,4}:){7}([0-9A-Fa-f]{1,4}|:))|(([0-9A-Fa-f]{1,4}:){6}(:[0-9A-Fa-f]{1,4}|((25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)(\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)){3})|:))|(([0-9A-Fa-f]{1,4}:){5}(((:[0-9A-Fa-f]{1,4}){1,2})|:((25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)(\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)){3})|:))|(([0-9A-Fa-f]{1,4}:){4}(((:[0-9A-Fa-f]{1,4}){1,3})|((:[0-9A-Fa-f]{1,4})?:((25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)(\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)){3}))|:))|(([0-9A-Fa-f]{1,4}:){3}(((:[0-9A-Fa-f]{1,4}){1,4})|((:[0-9A-Fa-f]{1,4}){0,2}:((25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)(\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)){3}))|:))|(([0-9A-Fa-f]{1,4}:){2}(((:[0-9A-Fa-f]{1,4}){1,5})|((:[0-9A-Fa-f]{1,4}){0,3}:((25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)(\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)){3}))|:))|(([0-9A-Fa-f]{1,4}:){1}(((:[0-9A-Fa-f]{1,4}){1,6})|((:[0-9A-Fa-f]{1,4}){0,4}:((25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)(\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)){3}))|:))|(:(((:[0-9A-Fa-f]{1,4}){1,7})|((:[0-9A-Fa-f]{1,4}){0,5}:((25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)(\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)){3}))|:)))(%.+)?\\s*$/.test(\n        hostname\n      ) ||\n      /^(?:((?:[a-z0-9-._~]{0,}|%[1-9a-f]?[0-9a-f]|[!$&'()*+,;=])|\\:|\\@)*)/i.test(\n        pathname\n      ) ||\n      /^((?:[a-z0-9-._~]{0,}|%[1-9a-f]?[0-9a-f]|[!$&'()*+,;=])|\\:|\\@|\\/|\\?)*$/i.test(\n        search\n      ) ||\n      /^((?:[a-z0-9-._~]{0,}|%[1-9a-f]?[0-9a-f]|[!$&'()*+,;=])|\\:|\\@|\\/|\\?)*$/i.test(\n        hash\n      )\n    ) {\n      if (hostname.includes('.00') || blockedHosts.indexOf(hostname) !== -1) {\n        return 'about:blank'\n      }\n\n      if (\n        pathname.toLowerCase().includes('&apos;') ||\n        pathname.toLowerCase().includes('%29') ||\n        pathname.toLowerCase().includes('%28') ||\n        pathname.toLowerCase().includes('%20') ||\n        pathname.toLowerCase().includes('%22') ||\n        pathname.toLowerCase().includes('&quot;') ||\n        pathname.toLowerCase().includes('(') ||\n        pathname.toLowerCase().includes(')') ||\n        pathname.toLowerCase().includes('%3e') ||\n        pathname.toLowerCase().includes('%3c') ||\n        pathname.toLowerCase().includes('><')\n      ) {\n        return 'about:blank'\n      }\n\n      if (\n        search.toLowerCase().match(/%3c(?=\\/)?/g) !== null ||\n        search.toLowerCase().includes('%3e') ||\n        search.toLowerCase().includes('%3f') ||\n        search.toLowerCase().includes('%3d') ||\n        search.toLowerCase().includes('%27') ||\n        search.toLowerCase().includes('%22') ||\n        search.toLowerCase().includes('&apos;') ||\n        search.toLowerCase().includes('&quot;') ||\n        search.toLowerCase().match(/\\.(?:jar|dmg|exe|bin|sh|sed|py)/g) !== null\n      ) {\n        return 'about:blank'\n      }\n    }\n  } catch (error) {\n    if (error) {\n      /* console.warn(`WARNING: unsafe URL > ${sanitizedUrl} (see https://g.co/ng/security#xss)`) */\n      return 'about:blank'\n    }\n  }\n\n  if (\n    !unsafeURISchemeRegex.test(urlScheme) ||\n    safeURIRegex.test(sanitizedUrl)\n  ) {\n    let pass = false\n\n    if (\n      options.allowScriptOrDataURI &&\n      urlScheme.match(/^(java|vb)script|data/) !== null &&\n      (dataURIBINRegex.test(sanitizedUrl) || scriptURIRegex.test(sanitizedUrl))\n    ) {\n      pass = true\n    }\n\n    if (options.allowCommsAppURI && commsAppURISchemeRegex.test(sanitizedUrl)) {\n      pass = true\n    }\n\n    if (\n      options.allowDBConnectionStringURI &&\n      databaseConnectionStringURISchemeRegex.test(sanitizedUrl)\n    ) {\n      pass = true\n    }\n\n    if (\n      options.allowServiceAPIURI &&\n      serviceAPIURISchemeRegex.test(sanitizedUrl)\n    ) {\n      pass = true\n    }\n\n    if (\n      options.allowBrowserSpecificURI &&\n      browserURISchemeRegex.test(sanitizedUrl)\n    ) {\n      pass = true\n    }\n\n    if (\n      options.allowWebTransportURI &&\n      webTransportURIRegex.test(sanitizedUrl)\n    ) {\n      pass = true\n    }\n\n    if (\n      options.allowFileSystemURI &&\n      fileSystemURISchemeRegex.test(sanitizedUrl)\n    ) {\n      pass = true\n    }\n\n    if (urlScheme !== '' && pass) {\n      return sanitizedUrl\n    } else {\n      /* console.warn(`WARNING: unsafe URL > ${sanitizedUrl} (see https://g.co/ng/security#xss)`) */\n      return 'about:blank'\n    }\n  }\n}\n\nconst URISanity = {\n  isSameOrigin,\n  extractParamValueFromUri,\n  checkParamsOverWhiteList,\n  vet (url, options = {}) {\n    return sanitizeUrl(url, options || {})\n  }\n}\n\nexport default URISanity\n"],"names":["unsafeURISchemeRegex","safeInternetURISchemeRegex","safeURIRegex","commsAppURISchemeRegex","databaseConnectionStringURISchemeRegex","browserURISchemeRegex","fileSystemURISchemeRegex","serviceAPIURISchemeRegex","blockedHosts","ctrlCharactersRegex","dataURIBINRegex","dataURITEXTRegex","scriptURIRegex","webTransportURIRegex","relativeFirstCharacters","$globals","self","global","nodeJSProcess","process","versions","node","env","NODE_MAJOR_VERSION","parseInt","split","URL","urlString","urlParser","require","parsedUrl","parse","Object","assign","hostname","host","isStandardBrowserEnv","environ","navigator","product","match","origin","location","constants","ORIGIN","isRelativeUrlWithoutProtocol","url","indexOf","charAt","extractParamValueFromUri","uri","paramName","test","trim","regex","RegExp","params","exec","unescape","formDataToJSON","elem","current","item","key","output","value","entries","FormData","next","prototype","hasOwnProperty","call","Array","isArray","push","_","fromEntries","JSON","stringify","isSameOrigin","error","checkParamsOverWhiteList","paramsWhiteList","data","paramKeys","paramValues","preparedData","json","object","forEach","searchParams","args","concat","values","length","slice","sort","join","paramsCounter","paramKey","paramValue","paramRegex","Error","sanitizeUrl","options","includes","sanitizedUrl","replace","originalSanitized","startsWith","urlSchemeParseResults","urlScheme","toLowerCase","pathname","search","hash","pass","allowScriptOrDataURI","allowCommsAppURI","allowDBConnectionStringURI","allowServiceAPIURI","allowBrowserSpecificURI","allowWebTransportURI","allowFileSystemURI","URISanity","vet"],"mappings":"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"}